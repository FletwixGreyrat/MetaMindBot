import datetime
import openai
from openai import OpenAI
from sqlalchemy import delete, select
from fsm import *   
import httpx
from os import getenv
from config import settings
from keyboards import *
from models import *
from asyncio import sleep
from aiogram.dispatcher import FSMContext
from dotenv import load_dotenv, find_dotenv
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker
from aiogram import Bot, Dispatcher, executor, types
from aiogram.contrib.fsm_storage.redis import RedisStorage2


storage = RedisStorage2(host='localhost', port=6379, db=5)



client = openai.OpenAI(
    api_key=settings.openai.token,
    base_url="https://api.proxyapi.ru/openai/v1",
)


engine = create_async_engine(url=settings.db.url, echo=settings.db.echo)

session_factory = async_sessionmaker(
        bind=engine,
        autoflush=False,
        autocommit=False,
        expire_on_commit=False
)

bot: Bot = Bot(token=settings.bot.token)
dp: Dispatcher = Dispatcher(bot=bot, storage=storage)





async def ask_gpt(messages: list):
    chat_completion = client.chat.completions.create(
            model="gpt-3.5-turbo-1106",
            messages=messages,
    )

    response_content = chat_completion.choices[0].message.content
    return response_content





@dp.message_handler(commands="start")
async def start_command(message: types.Message):
    async with session_factory() as session:
        stmt = select(User).where(User.user_id == message.from_user.id)
        res = await session.execute(statement=stmt)
        if res.scalar() is None:
            stmt = insert(User).values(user_id=message.from_user.id, datetime=datetime.datetime.now().strftime('%Y-%m-%d'))
            await session.execute(statement=stmt)
            await session.commit()
    await message.answer("""
–ü—Ä–∏–≤–µ—Ç! –Ø, MetaMindBot –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å —Ü–µ–ª—å—é —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–∑–≤–∏—Ç–∏—è –º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤, –≤–∫–ª—é—á–∞—è –æ—Å–æ–∑–Ω–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Ä–µ—Ñ–ª–µ–∫—Å–∏—é, —Å–∞–º–æ–æ—Ü–µ–Ω–∫—É –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è (—Ä–∞–∑–≤–∏—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –æ–±—É—á–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
–Ø ‚Äî —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤. –ú–µ–Ω—è –∑–æ–≤—É—Ç MetaMindBot ü§ñ\n\n"
"üîπ –ú–µ–Ω—è —Å–æ–∑–¥–∞–ª–∞ –ï–ª–µ–Ω–∞ –ó–∞–ø–æ–¥–æ–π–Ω–∏–∫–æ–≤–∞, –ø—Å–∏—Ö–æ–ª–æ–≥, –Ω–µ–π—Ä–æ–ø—Å–∏—Ö–æ–ª–æ–≥, —Å–≤–æ–±–æ–¥–Ω—ã–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å, –∞—Å–ø–∏—Ä–∞–Ω—Ç-—ç–∫—Å—Ç–µ—Ä–Ω, "
"–∞–≤—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ ¬´–ö—É–ª—å—Ç—É—Ä–∞ –ò–ò: —É–º–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ¬ª –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ —É—á–∏—Ç—å—Å—è, –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å "
"—Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –ª—É—á—à–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è.  –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –µ—ë –∫–∞–Ω–∞–ª: @eduneuro2025\n\n"
"üìå –í–∞–∂–Ω–æ: –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞. –ú–µ—Ç–æ–¥–∏–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π, –∞–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã. "
"üîπ –°–æ –º–Ω–æ–π —Ç—ã –Ω–∞—É—á–∏—à—å—Å—è:\n"
"üîπ ‚Äî –†–µ—Ñ–ª–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –¥–µ–Ω—å\n"
"üîπ ‚Äî –£–ª—É—á—à–∞—Ç—å —É—á–µ–±–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏\n"
"üîπ ‚Äî –†–∞–∑–≤–∏–≤–∞—Ç—å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å\n"
"üîπ ‚Äî –†–∞–±–æ—Ç–∞—Ç—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏ –±—ã—Å—Ç—Ä–æ\n"
"üîπ ‚Äî –ì–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ —ç–∫–∑–∞–º–µ–Ω–∞–º –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞\n"
"üîπ ‚Äî –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n"
"üîπ ‚Äî –ü—Ä–∏–º–µ–Ω—è—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞\n\n"
"üî• –î–∞–≤–∞–π –Ω–∞—á–Ω–µ–º! –í—ã–±–µ—Ä–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è! üî•"
–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ—Ç?z
1.	–ü—Ä–æ–π–¥–∏ –≤—Ö–æ–¥–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äì —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —à–∞–≥ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã.
2.	–ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –ø–æ–ª—É—á–∏—à—å –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞.
3.	–°–ª–µ–¥—É–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–º—É –≥—Ä–∞—Ñ–∏–∫—É (3 –∑–∞–Ω—è—Ç–∏—è –≤ –Ω–µ–¥–µ–ª—é): 
    o	–ú–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (/train)
    o	–¢—Ä–µ–Ω–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π (üß† InfoTraining)
    o	–†–µ—Ñ–ª–µ–∫—Å–∏—è (/reflect)
    o	–ü–æ–º–æ–¥–æ—Ä–æ-—Ç–∞–π–º–µ—Ä –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è (/pomodoro)
4.	–ß–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞ –±–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (/retest).
5.	–ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥–¥–µ—Ä–∂–∫—É: 
    o	–ï—Å–ª–∏ —É —Ç–µ–±—è –ø—Ä–æ–±–ª–µ–º—ã —Å –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π ‚Äî –Ω–∞–ø–∏—à–∏ –≤ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —á–∞—Ç (/psych_chat).
üöÄ –î–∞–≤–∞–π –Ω–∞—á–Ω–µ–º! –î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–π–¥–∏ –≤—Ö–æ–¥–Ω—ã–µ —Ç–µ—Å—Ç—ã:
    <a href="https://onlinetestpad.com/s/academic-text-skills">–¢–µ—Å—Ç 1</a>
    <a href="https://onlinetestpad.com/t/borzova-text-test">–¢–µ—Å—Ç 2</a>
    <a href="https://onlinetestpad.com/t/starkey2004-lutsenko2014">–¢–µ—Å—Ç 3</a>
    <a href="https://onlinetestpad.com/t/arpov-reflection-test">–¢–µ—Å—Ç 4</a>
    <a href="https://onlinetestpad.com/t/Metacognition-activity">–¢–µ—Å—Ç 5</a>
    <a href="https://onlinetestpad.com/t/merkulova-ak-test">–¢–µ—Å—Ç 6</a>""", parse_mode="html")

    await sleep(90 * 24 * 60 * 60)

    await message.answer("""–ü—Ä–∏–≤–µ—Ç!
–£ —Ç–µ–±—è –≤—Å–µ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è. –¢—ã –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è —É–∂–µ 3 –º–µ—Å—è—Ü–∞, —Å—É–ø–µ—Ä!
–ù–∞—Å—Ç–∞–ª–æ –≤—Ä–µ–º—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, –ø—Ä–æ–π–¥—è –∑–∞–Ω–æ–≤–æ —Ç–µ—Å—Ç—ã. –°–º–µ–ª–æ –ø–∏—à–∏ /retest""", parse_mode="html")


@dp.message_handler(commands="help")
async def help_cmd(message: types.Message):
    await message.answer("""üìå –ü–æ–º–æ—â—å –ø–æ MetaMindBot

–ü—Ä–∏–≤–µ—Ç! üëã –Ø **MetaMindBot**, —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ —Ä–∞–∑–≤–∏—Ç–∏–∏ **–º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤**. –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —É–ª—É—á—à–∏—Ç—å –ø–∞–º—è—Ç—å, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ –∏ –Ω–∞—É—á–∏—Ç—å—Å—è –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç—å –∫ –æ–±—É—á–µ–Ω–∏—é.  

–í–æ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:  

**üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å**  
üîπ **/retest** ‚Äì –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞.  
üîπ **/profile** ‚Äì –û—Ü–µ–Ω–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∏ –Ω–∞–≤—ã–∫–æ–≤.  

**üß† –û–±—É—á–µ–Ω–∏–µ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏**  
üîπ **/reflect** ‚Äì –†–µ—Ñ–ª–µ–∫—Å–∏—è –¥–Ω—è (–∞–Ω–∞–ª–∏–∑ —É—Å–ø–µ—Ö–æ–≤ –∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π).  
üîπ **/train** ‚Äì –ú–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–ª–æ–≥–∏–∫–∞, –≤–Ω–∏–º–∞–Ω–∏–µ, –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å).  
üîπ **/info_training** ‚Äì –¢—Ä–µ–Ω–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ, –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö).  
üîπ **/quiz** ‚Äì –ö–≤–∏–∑—ã –ø–æ —Ä–∞–∑–Ω—ã–º –ø—Ä–µ–¥–º–µ—Ç–∞–º.  
üîπ **/courses** ‚Äì –ü–æ–¥–±–æ—Ä–∫–∞ –ø–æ–ª–µ–∑–Ω—ã—Ö –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å–æ–≤.  

**üí° –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**  
üîπ **/psych_chat** ‚Äì –ß–∞—Ç —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º (–ò–ò –ø–æ–º–æ–∂–µ—Ç —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å–æ —Å—Ç—Ä–µ—Å—Å–æ–º).  
üîπ **/pomodoro** ‚Äì Pomodoro-—Ç–∞–π–º–µ—Ä –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π —É—á–µ–±—ã.  


**üìö –ü–æ–ª–µ–∑–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã**  
üîπ **/resources** ‚Äì –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Ç–∞—Ç—å–∏, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.  

üìå **–°–æ–≤–µ—Ç:** –ù–∞—á–Ω–∏ —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è **/test**, –ø—Ä–æ—Ö–æ–¥–∏ **—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é**, –∏—Å–ø–æ–ª—å–∑—É–π **Pomodoro-—Ç–∞–π–º–µ—Ä** –∏ –Ω–µ –∑–∞–±—ã–≤–∞–π **—Ä–µ—Ñ–ª–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å**!  

–ï—Å–ª–∏ —É —Ç–µ–±—è –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ! üöÄ""")


@dp.callback_query_handler(text="start_test")
async def start_test_callback_cmd(call: types.CallbackQuery):
    await call.message.edit_text("""–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    
""", reply_markup=auth_code())


@dp.callback_query_handler(text="auth_code")
async def auth_code_callback_command(call: types.CallbackQuery):
    await call.message.edit_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥:")
    await Auth.code.set()


@dp.message_handler(commands="pomodoro")
async def pomodoro_CMD(message: types.Message):
    async with session_factory() as session:
        stmt = select(PomodoroUser).where(PomodoroUser.user_id == message.from_user.id)
        user = await session.execute(statement=stmt)
        user = user.scalar()
        await session.commit()
    print(user)
    if user is not None:
        print(1)
        async with session_factory() as session:
            stmt = delete(PomodoroUser).where(PomodoroUser.user_id == message.from_user.id)
            await session.execute(statement=stmt)
            await session.commit()
            return
    if user is None:
        async with session_factory() as session:
            stmt = insert(PomodoroUser).values(user_id=message.from_user.id)
            user = await session.execute(statement=stmt)
            await session.commit()
        while True:
            await message.answer("Start1")
            await sleep(5) #TODO 20 * 60
            async with session_factory() as session:
                stmt = select(PomodoroUser).where(PomodoroUser.user_id == message.from_user.id)
                user = await session.execute(statement=stmt)
                user = user.scalar()
            if user is None:
                print("3")
                return
            
            await message.answer("Start2")
            await sleep(2) #TODO 5 * 60

            async with session_factory() as session:
                stmt = select(PomodoroUser).where(PomodoroUser.user_id == message.from_user.id)
                user = await session.execute(statement=stmt)
                user = user.scalar()
            if user is None:
                print("2")
                return


# @dp.message_handler(commands="train")
# async def train_CMD(message: types.Message):
#     await message.answer("""–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è! –¢—ã –Ω–∞ –≤–µ—Ä–Ω–æ–º –ø—É—Ç–∏!
# –ó–∞–ø–æ–º–Ω–∏, —á—Ç–æ  —ç—Ç–∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ä–∞–∑–≤–∏–≤–∞—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤: –æ—Å–æ–∑–Ω–∞–Ω–∏–µ –º—ã—à–ª–µ–Ω–∏—è, —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏—è, —Ä–∞–∑–≤–∏—Ç–∏–µ –ø–∞–º—è—Ç–∏ –∏ –æ–±—É—á–µ–Ω–∏–µ.
# –í—ã–ø–æ–ª–Ω—è–π –∏—Ö 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 3 –º–µ—Å—è—Ü–µ–≤ –∏ —Ç—ã –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å, –∫–∞–∫ –ø—Ä–æ–∫–∞—á–∏–≤–∞—é—Ç—Å—è —Ç–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑ –∑–∞ —Ä–∞–∑–æ–º""",)












































import logging
from aiogram import Bot, Dispatcher, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup
from aiogram.utils import executor
from sqlalchemy.orm import sessionmaker


# –ù–∞—Å—Ç—Ä–æ–π–∫–∏


# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM
class ExerciseStates(StatesGroup):
    num_of_task = State()


class Exercise1(StatesGroup):
    q1 = State()
    q2 = State()
    q3 = State()
    q4 = State()
    q5 = State()


class Exercise2(StatesGroup):
    q1 = State()
    q2 = State()
    q3 = State()
    q4 = State()

class Exercise3(StatesGroup):
    q1 = State()
    q2 = State()
    q3 = State()
    q4 = State()


class Exercise4(StatesGroup):
    q1 = State()
    q2 = State()
    q3 = State()


class Exercise(StatesGroup):
    answers = State()


class ExerciseInfoTraining(StatesGroup):
    answers = State()



train_dict = {
    "–ó–∞–¥–∞–Ω–∏–µ 1. ¬´–≠–∫–∑–∞–º–µ–Ω —á–µ—Ä–µ–∑ 3 –¥–Ω—è¬ª": {"""–ü—Ä–µ–¥—Å—Ç–∞–≤—å —Å–∏—Ç—É–∞—Ü–∏—é, —á—Ç–æ —Ç—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª(–∞), —á—Ç–æ —á–µ—Ä–µ–∑ 3 –¥–Ω—è —É —Ç–µ–±—è –≤–∞–∂–Ω—ã–π —ç–∫–∑–∞–º–µ–Ω, –Ω–æ —Ç—ã –∑–Ω–∞–µ—à—å —Ç–µ–º—É –ª–∏—à—å –Ω–∞–ø–æ–ª–æ–≤–∏–Ω—É, –ª–∏–±–æ –≤–æ–æ–±—â–µ –µ—ë –Ω–µ –∑–Ω–∞–µ—à—å, —á—Ç–æ –±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ. –í—Ä–µ–º–µ–Ω–∏ —Å–æ–≤—Å–µ–º –º–∞–ª–æ, –∞ –µ—â—ë –Ω—É–∂–Ω–æ —É—Å–ø–µ—Ç—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –ø–æ –¥—Ä—É–≥–∏–º –ø—Ä–µ–¥–º–µ—Ç–∞–º.  3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –º–µ–Ω—è–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤ –ø–æ–∏—Å–∫–∞—Ö —Å–∞–º–æ–π –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –¥–ª—è —Å–µ–±—è.
–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø–∏—à–∏ –∏—Ö –≤ –±–æ—Ç–µ""" : ["1Ô∏è. –ß—Ç–æ —Ç—ã –∑–Ω–∞–µ—à—å –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ?", "2Ô∏è. –ö–∞–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã –µ—Å—Ç—å? –ö–∞–∫ —Ç—ã —ç—Ç–æ –ø–æ–Ω—è–ª?", "3. –ö–∞–∫–∏–µ –º–µ—Ç–æ–¥—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å? –ö–∞–∫–∏–µ –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—Ç?", "4. –ö–∞–∫ —Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—à—å –≤—Ä–µ–º—è –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É?", "5Ô∏è. –û—Ü–µ–Ω–∏ —Å–≤–æ—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 4. –ö–∞–∫ –º–æ–∂–Ω–æ –ø–æ–≤—ã—Å–∏—Ç—å –µ—ë?"]},
    "–ó–∞–¥–∞–Ω–∏–µ 2. ¬´–¢—ã –ø—Ä–µ–ø–æ–¥–∞—ë—à—å!¬ª": {"""–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å —Ç–µ–º—É, –Ω–∞–ø—Ä–∏–º–µ—Ä ¬´–≠–Ω–µ—Ä–≥–∏—è –≤ —Ñ–∏–∑–∏–∫–µ¬ª –∏–ª–∏ –ª—é–±—É—é —Ç–µ–º—É –Ω–∞ —Ç–≤–æ—ë —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ,  –¥—Ä—É–≥—É, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–≤—Å–µ–º –µ—ë –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç. –ù–æ –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: —É —Ç–µ–±—è —Ç–æ–ª—å–∫–æ 2 –º–∏–Ω—É—Ç—ã!  3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –º–µ–Ω—è–π –≤—Ä–µ–º—è –∏  —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤ –ø–æ–∏—Å–∫–∞—Ö —Å–∞–º–æ–π –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –¥–ª—è —Å–µ–±—è.
–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø–∏—à–∏ –∏—Ö –≤ –±–æ—Ç–µ""": ["1Ô∏è. –ö–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è –Ω—É–∂–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å?", "2Ô∏è. –ö–∞–∫ –æ–±—ä—è—Å–Ω–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ?", "3Ô∏è. –ö–∞–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –ø–æ–º–æ–≥—É—Ç –ø–æ–Ω—è—Ç—å —Ç–µ–º—É?", "4Ô∏è. –ö–∞–∫ —Ç—ã –ø—Ä–æ–≤–µ—Ä–∏—à—å, —á—Ç–æ –¥—Ä—É–≥ –ø–æ–Ω—è–ª?", ]},
    "–ó–∞–¥–∞–Ω–∏–µ 3. ¬´–ß—Ç–æ –Ω–µ —Ç–∞–∫ —Å —ç—Ç–∏–º —Ç–µ–∫—Å—Ç–æ–º?¬ª": {"""–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã —á–∏—Ç–∞–µ—à—å —Å—Ç–∞—Ç—å—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ: ¬´–ß–µ–º –±–æ–ª—å—à–µ –∫–æ—Ñ–µ —Ç—ã –ø—å—ë—à—å, —Ç–µ–º –≤—ã—à–µ IQ¬ª (–ª–∏–±–æ –≤—ã–±–µ—Ä–∏ –ª—é–±—É—é –¥—Ä—É–≥—É—é —Å—Ç–∞—Ç—å—é –Ω–∞ –≤—ã–±–æ—Ä). –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–≤—É—á–∏—Ç —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ.  3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –º–µ–Ω—è–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏  –∏ —Å—Ç–∞—Ç—å–∏ (–ª—é–±—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –∏ –∏–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö) –≤ –ø–æ–∏—Å–∫–∞—Ö —Å–∞–º–æ–π –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –¥–ª—è —Å–µ–±—è.
–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø–∏—à–∏ –∏—Ö –≤ –±–æ—Ç–µ""": ["1Ô∏è. –ö–∞–∫–∏–µ –¥–æ–≤–æ–¥—ã –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è?", "2Ô∏è. –ï—Å—Ç—å –ª–∏ —É –∞–≤—Ç–æ—Ä–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞? –ì–¥–µ –æ–Ω –≤–∑—è–ª —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ?", "3Ô∏è. –ö–∞–∫ –±—ã —Ç—ã –ø—Ä–æ–≤–µ—Ä–∏–ª, –ø—Ä–∞–≤–¥–∞ –ª–∏ —ç—Ç–æ?", "4Ô∏è. –ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è, –µ—Å–ª–∏ –º—ã –¥–æ–±–∞–≤–∏–º —Ñ—Ä–∞–∑—É: ¬´–ü–æ –¥–∞–Ω–Ω—ã–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ì–∞—Ä–≤–∞—Ä–¥–∞ –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞¬ª?"]},
    "–ó–∞–¥–∞–Ω–∏–µ 4. ¬´–†–∞–∑–≤–∏—Ç–∏–µ –Ω–∞–≤—ã–∫–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è¬ª": {"""–°–∏—Ç—É–∞—Ü–∏—è: –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –≤—ã–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç (–≤–æ–∑—å–º–∏ –ª—é–±—É—é —Å—Ç–∞—Ç—å—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ, –ª–∏–±–æ –ø–∞—Ä–∞–≥—Ä–∞—Ñ –≤ —É—á–µ–±–Ω–∏–∫–µ) –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è, –Ω–æ –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º —Ç—ã –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ. 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –º–µ–Ω—è–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤ –ø–æ–∏—Å–∫–∞—Ö —Å–∞–º–æ–π –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –¥–ª—è —Å–µ–±—è.
–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø–∏—à–∏ –∏—Ö –≤ –±–æ—Ç–µ""": ["1. –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Ç–µ–∫—Å—Ç–∞.", "2. –°–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–π, –æ —á–µ–º –≤ –Ω–µ–º –ø–æ–π–¥–µ—Ç —Ä–µ—á—å.", "3. –ü–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è —Å—Ä–∞–≤–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º, –Ω–∞–ø–∏—à–∏ —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –∞ —á—Ç–æ –Ω–µ—Ç."]}
}



@dp.message_handler(commands='s', state=ExerciseStates)
async def s(message: types.Message, state: FSMContext):
    await state.finish()

@dp.message_handler(commands='s', state=Exercise)
async def ss(message: types.Message, state: FSMContext):
    await state.finish()

@dp.message_handler(commands=['train'])
async def train_start_cmd(message: types.Message, state: FSMContext):

    kb = types.ReplyKeyboardMarkup()
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 1. ¬´–≠–∫–∑–∞–º–µ–Ω —á–µ—Ä–µ–∑ 3 –¥–Ω—è¬ª"))
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 2. ¬´–¢—ã –ø—Ä–µ–ø–æ–¥–∞—ë—à—å!¬ª"))
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 3. ¬´–ß—Ç–æ –Ω–µ —Ç–∞–∫ —Å —ç—Ç–∏–º —Ç–µ–∫—Å—Ç–æ–º?¬ª"))
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 4. ¬´–†–∞–∑–≤–∏—Ç–∏–µ –Ω–∞–≤—ã–∫–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è¬ª"))


    await message.answer("""–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è! –¢—ã –Ω–∞ –≤–µ—Ä–Ω–æ–º –ø—É—Ç–∏! –ó–∞–ø–æ–º–Ω–∏, —á—Ç–æ  —ç—Ç–∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è  —Ä–∞–∑–≤–∏–≤–∞—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤: –æ—Å–æ–∑–Ω–∞–Ω–∏–µ –º—ã—à–ª–µ–Ω–∏—è, —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏—è, —Ä–∞–∑–≤–∏—Ç–∏–µ –ø–∞–º—è—Ç–∏ –∏ –æ–±—É—á–µ–Ω–∏–µ. –í—ã–ø–æ–ª–Ω—è–π –∏—Ö 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 3 –º–µ—Å—è—Ü–µ–≤ –∏ —Ç—ã –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å, –∫–∞–∫ –ø—Ä–æ–∫–∞—á–∏–≤–∞—é—Ç—Å—è —Ç–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑ –∑–∞ —Ä–∞–∑–æ–º. 
–î–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π Pomodoro —Ç–∞–π–º–µ—Ä (–∫–Ω–æ–ø–∫–∞ /pomodoro ‚Äì Pomodoro-—Ç–∞–π–º–µ—Ä)""", reply_markup=kb)
    await Exercise.answers.set()

    async with state.proxy() as data:
        data["questions"] = ["–ó–∞–¥–∞–Ω–∏–µ 1. ¬´–≠–∫–∑–∞–º–µ–Ω —á–µ—Ä–µ–∑ 3 –¥–Ω—è¬ª", \
        "–ó–∞–¥–∞–Ω–∏–µ 2. ¬´–¢—ã –ø—Ä–µ–ø–æ–¥–∞—ë—à—å!¬ª", \
        "–ó–∞–¥–∞–Ω–∏–µ 3. ¬´–ß—Ç–æ –Ω–µ —Ç–∞–∫ —Å —ç—Ç–∏–º —Ç–µ–∫—Å—Ç–æ–º?¬ª", \
        "–ó–∞–¥–∞–Ω–∏–µ 4. ¬´–†–∞–∑–≤–∏—Ç–∏–µ –Ω–∞–≤—ã–∫–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è¬ª"]
        data["active_question"] = None
        data["all_answers"] = []
        data["only_answers"] = []


    

@dp.message_handler(content_types="text", state=Exercise.answers)
async def select_task_command(message: types.Message, state: FSMContext):

    kb = types.ReplyKeyboardMarkup()
    async with state.proxy() as data:
        for i in data["questions"]:
            kb.add(i)
        

        if not message.text in data["questions"] and data["active_question"] is None:
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ –∏–∑ –∑–∞–¥–∞–Ω–∏–π –ø–æ –∫–Ω–æ–ø–∫–∞–º –Ω–∏–∂–µ", reply_markup=kb)
            return
        
        if message.text in data["questions"] and data["active_question"] is None:
            if message.text == "–ó–∞–¥–∞–Ω–∏–µ 1. ¬´–≠–∫–∑–∞–º–µ–Ω —á–µ—Ä–µ–∑ 3 –¥–Ω—è¬ª":
                data["amount_of_questions"] = 5
                data["n"] = 1


            elif message.text == "–ó–∞–¥–∞–Ω–∏–µ 2. ¬´–¢—ã –ø—Ä–µ–ø–æ–¥–∞—ë—à—å!¬ª":
                data["amount_of_questions"] = 4
                data["n"] = 2

            elif message.text == "–ó–∞–¥–∞–Ω–∏–µ 3. ¬´–ß—Ç–æ –Ω–µ —Ç–∞–∫ —Å —ç—Ç–∏–º —Ç–µ–∫—Å—Ç–æ–º?¬ª":
                data["amount_of_questions"] = 4
                data["n"] = 3

            else:
                data["amount_of_questions"] = 3
                data["n"] = 4

            data["all_answers"].append(message.text)

            data["count"] = 1

            data["questions"].remove(message.text)
            data["active_question"] = message.text
            data["dct"] = train_dict[message.text]
            
            for i in data["dct"]:
                await message.answer(i)
                data["all_answers"].append(i)
                data["all_answers"].append(data["dct"][i][0])
                await message.answer(data["dct"][i][0])
            
            return
        
        if not message.text in data["questions"] and data["active_question"] is not None:
            
            if len(message.text.split()) < 6:
                await message.answer("–ù–∞–ø–∏—à–∏ –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –Ω–µ –º–µ–Ω–µ–µ 6 —Å–ª–æ–≤")
                return
            
            if data["count"] == data["amount_of_questions"]:
                
                await message.answer("–¢—ã –º–æ–ª–æ–¥–µ—Ü, –æ—Ç–ª–∏—á–Ω–æ –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!", reply_markup=kb)
                data["all_answers"].append(message.text)
                data["active_question"] = None
                data["only_answers"].append(message.text)


                dat = "\n".join(data["all_answers"])

                messages = [
                    {"role": "user", "content": "–ü—Ä–∏–≤–µ—Ç. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è —ç—Ç–∏–º —É–∂–µ 40 –ª–µ—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –°–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥. –ù–∏–∂–µ –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –∫ –Ω–µ–º—É"},
                    {"role": "user", "content": dat}
                ]




                if len(data["questions"]) == 0:
                    res = await ask_gpt(messages=messages)
                    await message.answer(res)
                    async with session_factory() as session:
                        stmt = insert(Train).values(user_id=message.from_user.id, answers="RAZDELITEL".join(data["all_answers"]))
                        await session.execute(statement=stmt)
                        await session.commit()
                    await state.finish()
                return

            data["all_answers"].append(message.text)
            data["only_answers"].append(message.text)
            for i in data["dct"]:
                await message.answer(data["dct"][i][data["count"]])
                data["all_answers"].append(data["dct"][i][data["count"]])


            data["count"] += 1
        




info_training_dict = {
    "–ó–∞–¥–∞–Ω–∏–µ 1. ¬´–í—ã–¥–µ–ª–∏ –≥–ª–∞–≤–Ω–æ–µ¬ª": {"–°–∏—Ç—É–∞—Ü–∏—è: –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Å–ø–µ–∫—Ç –ø–æ —Å–ª–æ–∂–Ω–æ–π —Ç–µ–º–µ. –û–¥–Ω–∞–∫–æ —Ç–µ–∫—Å—Ç –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–≥–æ –Ω–µ–Ω—É–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã–¥–µ–ª–∏—Ç—å –∏–∑ –Ω–µ–≥–æ —Ç–æ–ª—å–∫–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ, —á—Ç–æ–±—ã –∑–∞–ø–æ–º–Ω–∏—Ç—å –±—ã—Å—Ç—Ä–µ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ.": ["1. –û —á—ë–º —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç?", "2. –ö–∞–∫–∏–µ 3 –≥–ª–∞–≤–Ω—ã–µ –∏–¥–µ–∏ —Ç—ã –≤—ã–¥–µ–ª–∏–ª(–∞)?", "3. –ö–∞–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–ª–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–≤—Ç–æ—Ä?", "4. –ï—Å–ª–∏ –±—ã —Ç–µ–±–µ –Ω—É–∂–Ω–æ –±—ã–ª–æ –æ–±—ä—è—Å–Ω–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –¥—Ä—É–≥—É –≤ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö, —á—Ç–æ –±—ã —Ç—ã —Å–∫–∞–∑–∞–ª(–∞)?", "5. –ö–∞–∫ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏?", ]},
    "–ó–∞–¥–∞–Ω–∏–µ 2. ¬´–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è?¬ª": {"""–°–∏—Ç—É–∞—Ü–∏—è: –í –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ –Ω–∏—Ö —Å–æ–¥–µ—Ä–∂–∞—Ç –ø—Ä–∞–≤–¥–∏–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–µ–π –∏–ª–∏ —Ñ–µ–π–∫–æ–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞—É—á–∏—Ç—å—Å—è –æ—Ç–ª–∏—á–∞—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –æ—Ç –ª–æ–∂–Ω—ã—Ö.  
–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—è —Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.""": ["1Ô∏è. –ö—Ç–æ –∞–≤—Ç–æ—Ä –Ω–æ–≤–æ—Å—Ç–∏? –ï—Å—Ç—å –ª–∏ —É –Ω–µ–≥–æ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è?", "2Ô∏è. –ï—Å—Ç—å –ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫–∏? –ì–¥–µ –∏—Ö –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å?", "3Ô∏è. –ï—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —ç–º–æ—Ü–∏–∏, –∫–ª–∏–∫–±–µ–π—Ç, –æ–±–æ–±—â–µ–Ω–∏—è?", "4Ô∏è. –û—Ü–µ–Ω–∏—Ç–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –ª–∏ –¥—Ä—É–≥–∏–µ –Ω–∞–¥—ë–∂–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é?", ""]},
    "–ó–∞–¥–∞–Ω–∏–µ 3. ¬´–°–æ—Å—Ç–∞–≤—å –∫–∞—Ä—Ç—É –∑–Ω–∞–Ω–∏–π¬ª": {"""–°–∏—Ç—É–∞—Ü–∏—è: –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –¥–ª–∏–Ω–Ω—É—é –Ω–∞—É—á–Ω—É—é —Å—Ç–∞—Ç—å—é/–∫–Ω–∏–≥—É –∏ –≤—ã–¥–µ–ª–∏—Ç—å –≥–ª–∞–≤–Ω–æ–µ, —Ç—ã —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–µ–∫—Ç –∏ —Ö–æ—á–µ—à—å —á–µ—Ç–∫–æ –ø–æ–Ω—è—Ç—å –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–ª–∏ —Ç—ã –≥–æ—Ç–æ–≤–∏—à—å—Å—è –∫ —ç–∫–∑–∞–º–µ–Ω—É –∏ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–µ ¬´–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Ç–µ–æ—Ä–∏–∏¬ª (–∏–ª–∏ –ª—é–±–∞—è –¥—Ä—É–≥–∞—è —Å–ª–æ–∂–Ω–∞—è —Ç–µ–º–∞).
–ö–æ–≥–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –≤–∏–¥–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ö–µ–º—ã, –µ—ë –ª–µ–≥—á–µ –∑–∞–ø–æ–º–Ω–∏—Ç—å. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø–æ–Ω—è—Ç–∏—è–º–∏ –∏ –≤—ã–¥–µ–ª–∏—Ç—å –≥–ª–∞–≤–Ω–æ–µ.""": ["1Ô∏è. –ö–∞–∫–æ–≤–∞ –≥–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞?", "2Ô∏è. –ö–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å?", "3Ô∏è. –ö–∞–∫ –º–æ–∂–Ω–æ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–≥—Ä–∞—Ñ–∏–∫–∏, —Å—Ö–µ–º—ã, —Ç–∞–±–ª–∏—Ü—ã)?", ]},
    "–ó–∞–¥–∞–Ω–∏–µ 4. ¬´–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω¬ª": {"""–°–∏—Ç—É–∞—Ü–∏—è: –í –º–∏—Ä–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–ø–æ—Ä–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç —Ä–∞–∑–Ω—ã–µ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è. –†–∞—Å—Å–º–æ—Ç—Ä–∏ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –Ω–∞ –≤—ã–±–æ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –¥–≤—É—Ö —Å—Ç–æ—Ä–æ–Ω, –ø—Ä–∏–≤–µ—Å—Ç–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã ¬´–∑–∞¬ª –∏ ¬´–ø—Ä–æ—Ç–∏–≤¬ª, –∞ –∑–∞—Ç–µ–º —Å–¥–µ–ª–∞—Ç—å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥. –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—è —Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã.
–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø–∏—à–∏ –∏—Ö –≤ –±–æ—Ç–µ:""": ["1Ô∏è. –ö–∞–∫—É—é —Ç–µ–º—É —Ç—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å? –û —á–µ–º –æ–Ω–∞.", "2Ô∏è. –ö–∞–∫–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –º–æ–∂–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –≤ –ø–æ–ª—å–∑—É —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ?", "3Ô∏è. –ö–∞–∫–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –º–æ–∂–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –ø—Ä–æ—Ç–∏–≤ —ç—Ç–æ–π —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è?", "4Ô∏è. –ö–∞–∫–æ–π —Ç–≤–æ–π –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ?"]},
    "–ó–∞–¥–∞–Ω–∏–µ 5. ¬´–í—ã—è–≤–∏ —Å–∫—Ä—ã—Ç—ã–µ —Å–º—ã—Å–ª–æ–≤—ã–µ —Å–≤—è–∑–∏¬ª": {"""–°–∏—Ç—É–∞—Ü–∏—è: –ß–∞—Å—Ç–æ –≤ —Ç–µ–∫—Å—Ç–∞—Ö, –Ω–æ–≤–æ—Å—Ç—è—Ö –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–∫—Ä—ã—Ç—ã–µ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ñ–∞–∫—Ç–∞–º–∏ –∏ —Å–æ–±—ã—Ç–∏—è–º–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã—è–≤–∏—Ç—å —ç—Ç–∏ —Å–≤—è–∑–∏ –∏ –æ–±—ä—è—Å–Ω–∏—Ç—å –∏—Ö –ª–æ–≥–∏—á–µ—Å–∫—É—é –ø—Ä–∏—Ä–æ–¥—É.
–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—è —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø–∏—à–∏ –∏—Ö –≤ –±–æ—Ç–µ:""": ["1Ô∏è. –ö–∞–∫—É—é —Ç–µ–º—É —Ç—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å?", "2Ô∏è. –ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã?", "3Ô∏è. –ö–∞–∫–∏–µ —Å–∫—Ä—ã—Ç—ã–µ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –º–æ–∂–Ω–æ –≤—ã—è–≤–∏—Ç—å –º–µ–∂–¥—É —ç—Ç–∏–º–∏ —Ñ–∞–∫—Ç–∞–º–∏?", "4Ô∏è. –ö–∞–∫ —ç—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —Ç–≤–æ–∏ –≤—ã–≤–æ–¥—ã?"]},
    "–ó–∞–¥–∞–Ω–∏–µ 6. ¬´–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º¬ª": {"""–°–∏—Ç—É–∞—Ü–∏—è: –¢—ã –ø–∏—à–µ—à—å –∫—É—Ä—Å–æ–≤—É—é, –¥–∏–ø–ª–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É –∏–ª–∏ —à–∫–æ–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, –∏ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—ã—Å—Ç—Ä–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ. –í–º–µ—Å—Ç–æ —á—Ç–µ–Ω–∏—è —Å–æ—Ç–µ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü –≤–∞–∂–Ω–æ —É–º–µ—Ç—å –≤—ã–¥–µ–ª—è—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞.
–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é, —á—Ç–æ–±—ã —Ä–∞–∑–≤–∏—Ç—å –Ω–∞–≤—ã–∫ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø–∏—à–∏ –∏—Ö –≤ –±–æ—Ç–µ:""": ["1Ô∏è. –ö–∞–∫–∞—è —Ç–µ–º–∞ —Ç–≤–æ–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è? (–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –µ—ë –∫—Ä–∞—Ç–∫–æ –∏ —Ç–æ—á–Ω–æ)", "2Ô∏è. –ö–∞–∫–∏–µ 5-7 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏–ª–∏ —Ñ—Ä–∞–∑ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞?", "3Ô∏è. –ö–∞–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ (–Ø–Ω–¥–µ–∫—Å, Google Scholar, eLibrary, , –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã –∏ –¥—Ä.)?", "4Ô∏è. –ö–∞–∫–∏–µ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∫–∞–∂—É—Ç—Å—è –Ω–∞–∏–±–æ–ª–µ–µ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–º–∏ –∏ –ø–æ—á–µ–º—É?"]},
    "–ó–∞–¥–∞–Ω–∏–µ 7. ¬´–ë—ã—Å—Ç—Ä–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ –æ–±—ä—ë–º–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏¬ª": {"""–°–∏—Ç—É–∞—Ü–∏—è: –ü—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –Ω–∞—É—á–Ω–æ–π –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤–∞–∂–Ω–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–æ –∏ –±—ã—Å—Ç—Ä–æ –µ—ë –∏–∑—É—á–∏—Ç—å, –≤—ã–¥–µ–ª–∏–≤ –∫–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞—É—á–∏—Ç—å—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —á—Ç–µ–Ω–∏—é –∏ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö.
–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é, —Ä–∞–±–æ—Ç–∞—è —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ —Ç–µ–∫—Å—Ç–æ–≤.
–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø–∏—à–∏ –∏—Ö –≤ –±–æ—Ç–µ:""": ["1Ô∏è. –ö–∞–∫–æ–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ —Ç—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å? (–ù–∞–∑–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä, –¥–∞—Ç–∞, —Å—Å—ã–ª–∫–∞)", "2Ô∏è. –ö–∞–∫—É—é –≥–ª–∞–≤–Ω—É—é –º—ã—Å–ª—å –ø–µ—Ä–µ–¥–∞—ë—Ç —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç? (–ö—Ä–∞—Ç–∫–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ –≤ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö)", "3Ô∏è. –ö–∞–∫–∏–µ 3-5 –∫–ª—é—á–µ–≤—ã—Ö –∏–¥–µ–π –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å?", "4Ô∏è. –ö–∞–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Å–≤–æ–µ–π —Ä–∞–±–æ—Ç–µ? (–¶–∏—Ç–∞—Ç—ã, –≤—ã–≤–æ–¥—ã, —Å—Å—ã–ª–∫–∏)"]},
}


@dp.message_handler(commands="info_training")
async def info_training_command(message: types.Message, state: FSMContext):
    kb = types.ReplyKeyboardMarkup()
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 1. ¬´–í—ã–¥–µ–ª–∏ –≥–ª–∞–≤–Ω–æ–µ¬ª"))
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 2. ¬´–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è?¬ª"))
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 3. ¬´–°–æ—Å—Ç–∞–≤—å –∫–∞—Ä—Ç—É –∑–Ω–∞–Ω–∏–π¬ª"))
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 4. ¬´–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω¬ª"))
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 5. ¬´–í—ã—è–≤–∏ —Å–∫—Ä—ã—Ç—ã–µ —Å–º—ã—Å–ª–æ–≤—ã–µ —Å–≤—è–∑–∏¬ª"))
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 6. ¬´–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º¬ª"))
    kb.add(types.KeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 7. ¬´–ë—ã—Å—Ç—Ä–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ –æ–±—ä—ë–º–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏¬ª"))


    await message.answer("""–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è! –¢—ã –Ω–∞ –≤–µ—Ä–Ω–æ–º –ø—É—Ç–∏! –ó–∞–ø–æ–º–Ω–∏, —á—Ç–æ  —ç—Ç–∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è  —Ä–∞–∑–≤–∏–≤–∞—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤: –æ—Å–æ–∑–Ω–∞–Ω–∏–µ –º—ã—à–ª–µ–Ω–∏—è, —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏—è, —Ä–∞–∑–≤–∏—Ç–∏–µ –ø–∞–º—è—Ç–∏ –∏ –æ–±—É—á–µ–Ω–∏–µ. –í—ã–ø–æ–ª–Ω—è–π –∏—Ö 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 3 –º–µ—Å—è—Ü–µ–≤ –∏ —Ç—ã –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å, –∫–∞–∫ –ø—Ä–æ–∫–∞—á–∏–≤–∞—é—Ç—Å—è —Ç–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑ –∑–∞ —Ä–∞–∑–æ–º. 
–î–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π Pomodoro —Ç–∞–π–º–µ—Ä (–∫–Ω–æ–ø–∫–∞ /pomodoro ‚Äì Pomodoro-—Ç–∞–π–º–µ—Ä)""", reply_markup=kb)
    await ExerciseInfoTraining.answers.set()

    async with state.proxy() as data:
        data["questions"] = ["–ó–∞–¥–∞–Ω–∏–µ 1. ¬´–í—ã–¥–µ–ª–∏ –≥–ª–∞–≤–Ω–æ–µ¬ª", \
        "–ó–∞–¥–∞–Ω–∏–µ 2. ¬´–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è?¬ª", \
        "–ó–∞–¥–∞–Ω–∏–µ 3. ¬´–°–æ—Å—Ç–∞–≤—å –∫–∞—Ä—Ç—É –∑–Ω–∞–Ω–∏–π¬ª", \
        "–ó–∞–¥–∞–Ω–∏–µ 4. ¬´–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω¬ª", \
        "–ó–∞–¥–∞–Ω–∏–µ 5. ¬´–í—ã—è–≤–∏ —Å–∫—Ä—ã—Ç—ã–µ —Å–º—ã—Å–ª–æ–≤—ã–µ —Å–≤—è–∑–∏¬ª", \
        "–ó–∞–¥–∞–Ω–∏–µ 6. ¬´–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º¬ª", \
        "–ó–∞–¥–∞–Ω–∏–µ 7. ¬´–ë—ã—Å—Ç—Ä–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ –æ–±—ä—ë–º–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏¬ª"]
        data["active_question"] = None
        data["all_answers"] = []
        data["only_answers"] = []


@dp.message_handler(content_types="text", state=ExerciseInfoTraining.answers)
async def select_task_command_info_training(message: types.Message, state: FSMContext):

    kb = types.ReplyKeyboardMarkup()
    async with state.proxy() as data:
        for i in data["questions"]:
            kb.add(i)
        

        if not message.text in data["questions"] and data["active_question"] is None:
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ –∏–∑ –∑–∞–¥–∞–Ω–∏–π –ø–æ –∫–Ω–æ–ø–∫–∞–º –Ω–∏–∂–µ", reply_markup=kb)
            return
        
        if message.text in data["questions"] and data["active_question"] is None:
            if message.text ==  "–ó–∞–¥–∞–Ω–∏–µ 1. ¬´–í—ã–¥–µ–ª–∏ –≥–ª–∞–≤–Ω–æ–µ¬ª":
                data["amount_of_questions"] = 5
                data["n"] = 1

            elif message.text == "–ó–∞–¥–∞–Ω–∏–µ 2. ¬´–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è?¬ª":
                data["amount_of_questions"] = 4
                data["n"] = 2

            elif message.text == "–ó–∞–¥–∞–Ω–∏–µ 3. ¬´–°–æ—Å—Ç–∞–≤—å –∫–∞—Ä—Ç—É –∑–Ω–∞–Ω–∏–π¬ª":
                data["amount_of_questions"] = 3
                data["n"] = 3

            elif message.text == "–ó–∞–¥–∞–Ω–∏–µ 4. ¬´–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω¬ª":
                data["amount_of_questions"] = 4
                data["n"] = 4
            
            elif message.text == "–ó–∞–¥–∞–Ω–∏–µ 5. ¬´–í—ã—è–≤–∏ —Å–∫—Ä—ã—Ç—ã–µ —Å–º—ã—Å–ª–æ–≤—ã–µ —Å–≤—è–∑–∏¬ª":
                data["amount_of_questions"] = 4
                data["n"] = 5

            elif message.text == "–ó–∞–¥–∞–Ω–∏–µ 6. ¬´–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º¬ª":
                data["amount_of_questions"] = 4
                data["n"] = 6

            elif message.text == "–ó–∞–¥–∞–Ω–∏–µ 7. ¬´–ë—ã—Å—Ç—Ä–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ –æ–±—ä—ë–º–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏¬ª":
                data["amount_of_questions"] = 4
                data["n"] = 7


            data["all_answers"].append(message.text)

            data["count"] = 1

            data["questions"].remove(message.text)
            data["active_question"] = message.text
            data["dct"] = info_training_dict[message.text]
            for i in data["dct"]:
                await message.answer(i)
                data["all_answers"].append(i)
                data["all_answers"].append(data["dct"][i][0])
                await message.answer(data["dct"][i][0])
            data["answers"] = []
            return
        
        if not message.text in data["questions"] and data["active_question"] is not None:

            if len(message.text.split()) < 6:
                await message.answer("–ù–∞–ø–∏—à–∏ –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –Ω–µ –º–µ–Ω–µ–µ 6 —Å–ª–æ–≤")
                return
            
            if data["count"] == data["amount_of_questions"]:
                
                await message.answer("–¢—ã –º–æ–ª–æ–¥–µ—Ü, –æ—Ç–ª–∏—á–Ω–æ –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!", reply_markup=kb)
                data["all_answers"].append(message.text)
                data["only_answers"].append(message.text)
                data["active_question"] = None


                dat = "\n".join(data["all_answers"])

                messages = [
                    {"role": "user", "content": "–ü—Ä–∏–≤–µ—Ç. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è —ç—Ç–∏–º —É–∂–µ 40 –ª–µ—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –°–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥. –ù–∏–∂–µ –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –∫ –Ω–µ–º—É"},
                    {"role": "user", "content": dat}
                ]

                if len(data["questions"]) == 0:
                    res = await ask_gpt(messages=messages)
                    await message.answer(res)
                    async with session_factory() as session:
                        stmt = insert(InfoTraining).values(user_id=message.from_user.id, answers="RAZDELITEL".join(data["all_answers"]))
                        await session.execute(statement=stmt)
                        await session.commit()
                    await state.finish()
                return
            
            data["all_answers"].append(message.text)
            data["only_answers"].append(message.text)
            for i in data["dct"]:
                await message.answer(data["dct"][i][data["count"]])
                data["all_answers"].append(data["dct"][i][data["count"]])
                
            data["count"] += 1





@dp.message_handler(commands="psych_chat")
async def psych_chat(message: types.Message, state: FSMContext):
    await NeuroChat.is_chat.set()
    async with state.proxy() as data:
        data["messages"] = [{"role": "user", "content": "–¢—ã –ø—Å–∏—Ö–æ–ª–æ–≥ –≤ —á–∞—Ç –±–æ—Ç–µ, –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è, —è–≤–ª—è—é—Ç—Å—è –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏ —Ç–≤–æ–∏–º –æ—Ç–≤–µ—Ç–æ–º. –ò–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∞ –ø–æ—Ç–æ–º —Ç–≤–æ–π –æ—Ç–≤–µ—Ç. –ù–µ –æ—Ç–≤–µ—á–∞–π –Ω–∏—á–µ–≥–æ, –ø–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –µ–≥–æ. –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –µ–≥–æ –∫–∞–∫ –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –æ–±—ä—è–≤–∏ –æ –Ω–∞—á–∞–ª–µ —Å–µ–∞–Ω—Å–∞, –∑–∞–¥–∞–π –∫–∞–∫–∏–µ-–Ω–∏–±—É–¥—å –≤–æ–ø—Ä–æ—Å—ã, –ø—Ä–æ–≤–µ–¥–∏ –ø–æ–ª–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"}]
        res = await ask_gpt(messages=data["messages"])
        data["messages"].append({"role": "user", "content": res})
    await message.answer("–ß–∞—Ç —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º –Ω–∞—á–∞–ª—Å—è!\n–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Å—è –∫–æ–º–∞–Ω–¥–æ–π /psych_chat")
    await message.answer(res)

@dp.message_handler(content_types="any", state=NeuroChat)
async def chat_with_gpt_psych(message: types.Message, state: FSMContext):
    if message.text is None:
        await message.answer("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –ø–æ–∫–∞ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é")
        return
    
    if message.text == "/psych_chat":
        await state.finish()
        await message.answer("–ß–∞—Ç —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω, –∂–¥–µ–º —Ç–µ–±—è –∑–∞–≤—Ç—Ä–∞!\n–î–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞ —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É /psych_chat")
        return
    
    async with state.proxy() as data:
        data["messages"].append({"role": "user", "content": message.text})
        res = await ask_gpt(messages=data["messages"])
        await message.answer(res)
        data["messages"].append({"role": "user", "content": res})





reflect_lst = ["1. –ö–∞–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–µ–±–µ –¥–∞–ª–∏—Å—å –ª–µ–≥—á–µ –≤—Å–µ–≥–æ? –ü–æ—á–µ–º—É?", \
               "2. –ö–∞–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞–ª–∏—Å—å –Ω–∞–∏–±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–º–∏? –ß—Ç–æ –≤—ã–∑–≤–∞–ª–æ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏—è?", \
                "3. –ö–∞–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–∫–∞–∑–∞–ª–∏—Å—å –Ω–∞–∏–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π?", \
                "4. –ö–∞–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π —Ç—ã –±—É–¥–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º?", \
                "5. –ö–∞–∫–∏–µ –æ—à–∏–±–∫–∏ —Ç—ã —Å–æ–≤–µ—Ä—à–∏–ª(–∞) –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π? –ö–∞–∫ –∏—Ö –º–æ–∂–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å –≤ –±—É–¥—É—â–µ–º?", \
                "6. –ö–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø–æ–≤–ª–∏—è–ª–æ –Ω–∞ —Ç–≤–æ—ë –º—ã—à–ª–µ–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏?", \
                "7. –ö–∞–∫ —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–∏–º–µ–Ω—è—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ –≤ —É—á—ë–±–µ, —Ä–∞–±–æ—Ç–µ –∏ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏?", \
                "8. –ö–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç—ã –∑–∞–º–µ—Ç–∏–ª(–∞) –≤ —Å–≤–æ—ë–º —É–º–µ–Ω–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å, –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é?", \
                "9. –ö–∞–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–µ–±–µ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å? –ü–æ—á–µ–º—É?", \
                "10. –ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å —Ç–≤–æ—ë –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π?"]


@dp.message_handler(commands="reflect")
async def reflect_command(message: types.Message, state: FSMContext):
    await message.answer("""–ü—Ä–∏–≤–µ—Ç! –¢—ã —Å–ª–∞–≤–Ω–æ –ø–æ—Ç—Ä—É–¥–∏–ª—Å—è –ø—Ä–æ–π–¥—è –∑–∞–Ω—è—Ç–∏—è, —Ç–µ–ø–µ—Ä—å –≤–∞–∂–Ω–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å –Ω–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏ —Å –ø–æ–º–æ—â—å—é —Ä–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
–ù–∞—á–Ω–µ–º‚Ä¶""")
    
    await Reflect.qiestions.set()

    async with state.proxy() as data:
        data["index"] = 1
        data["answers"] = []

    await message.answer(reflect_lst[0])
    
@dp.message_handler(commands=["sex"], state=Reflect)
async def asdkfjsdf(message: types.Message, state: FSMContext):
    await state.finish()


@dp.message_handler(content_types="text", state=Reflect)
async def reflect_answers(message: types.Message, state: FSMContext):
    async with state.proxy() as data:

        if data["index"] == len(reflect_lst):
            print(data["answers"])
            data["answers"].append(message.text)

            async with session_factory() as session:
                stmt = insert(ReflectAnswers).values(user_id=message.from_user.id, answers="RAZDELITEL".join(data["answers"]))
                await session.execute(statement=stmt)
                await session.commit()


            await state.finish()
            await message.answer("""–°–ø–∞—Å–∏–±–æ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è! –ù–∞–¥–µ—é—Å—å —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å. –ó–∞–Ω–∏–º–∞–π—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –∏ –Ω–µ –∑–∞–±—ã–≤–∞–π —Ä–µ—Ñ–ª–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å. –¢–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∞–π–º–µ—Ä Pomodoro –ø–æ –∫–Ω–æ–ø–∫–µ /pomodoro ‚Äì Pomodoro-—Ç–∞–π–º–µ—Ä. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–æ–±—â–∞–π—Å—è —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º /psych_chat ‚Äì –ß–∞—Ç —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º –∏ –Ω–µ –∑–∞–±—É–¥—å –ø—Ä–æ–π—Ç–∏ –∏—Ç–æ–≥–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ 3 –º–µ—Å—è—Ü–µ–≤ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π –ø–æ –∫–Ω–æ–ø–∫–µ /retest ‚Äì –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞. –£–¥–∞—á–∏ —Ç–µ–±–µ!""")
            pr_lst = []
            for i in range(len(reflect_lst)):
                pr_lst.append(reflect_lst[i])
                pr_lst.append(data["answers"][i])
            pr_lst = "\n".join(pr_lst)

            messages = [{"role": "user", "content": "–ü—Ä–∏–≤–µ—Ç. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è —ç—Ç–∏–º —É–∂–µ 40 –ª–µ—Ç. –¢–æ–ª—å–∫–æ —á—Ç–æ –±—ã–ª–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏—è, —Å–µ–π—á–∞—Å —è —Ç–µ–±–µ –≤—Å–µ —Å–∫–∏–Ω—É. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏."},
                        {"role": "user", "content": pr_lst}]

            res = await ask_gpt(messages=messages)
            await message.answer(res)


    if len(message.text.split()) < 6:
        await message.answer("–ù–∞–ø–∏—à–∏ –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –Ω–µ –º–µ–Ω–µ–µ 6 —Å–ª–æ–≤")
        return
    

    async with state.proxy() as data:
        await message.answer(reflect_lst[data["index"]])
        data["index"] += 1
        data["answers"].append(message.text)



@dp.message_handler(commands="profile")
async def profile_command(message: types.Message):
    async with session_factory() as session: 
        stmt = select(Train.answers).where(Train.user_id == message.from_user.id)
        res = await session.execute(statement=stmt)
        res = res.scalars().all()
        if res is not None:
            res1 = []
            for i in res:
                res1.append("\n".join(i.split("RAZDELITEL")))

        else:
            res1 = ["–¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç"]
    


        stmt = select(InfoTraining.answers).where(InfoTraining.user_id == message.from_user.id)
        res = await session.execute(statement=stmt)
        res = res.scalars().all()
        if res is not None:
            res_t_1 = []
            for i in res:
                res_t_1.append("\n".join(i.split("RAZDELITEL")))

        else:
            res_t_1 = ["–¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç"]



        stmt = select(ReflectAnswers.answers).where(ReflectAnswers.user_id == message.from_user.id)
        res = await session.execute(statement=stmt)
        res = res.scalars().all()
        if res is not None:
            ref = []
            for i in res:
                ref.append("\n".join(i.split("RAZDELITEL")))

        else:
            ref = ["–¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç"]

        

        messages = [
            {"role": "user", "content": "–ü—Ä–∏–≤–µ—Ç. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è —ç—Ç–∏–º —É–∂–µ 40 –ª–µ—Ç. –¢—ã –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å —Ü–µ–ª—å—é —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–∑–≤–∏—Ç–∏—è –º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤, –≤–∫–ª—é—á–∞—è –æ—Å–æ–∑–Ω–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Ä–µ—Ñ–ª–µ–∫—Å–∏—é, —Å–∞–º–æ–æ—Ü–µ–Ω–∫—É –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è (—Ä–∞–∑–≤–∏—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –æ–±—É—á–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π. –°–µ–π—á–∞—Å —Ç–µ–±–µ –ø–µ—Ä–µ–¥–∞—Å—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤, —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–π, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–∞–π —Å–≤–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –±—É–¥—É—Ç –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∏–∂–µ."}
        ]

        for i in res1:
            messages.append({"role": "user", "content": i})

        for i in res_t_1:
            messages.append({"role": "user", "content": i})

        for i in ref:
            messages.append({"role": "user", "content": i})

        ans = await ask_gpt(messages=messages)
        await message.answer(ans)


@dp.message_handler(commands="retest")
async def retest_command(message: types.Message):

    async with session_factory() as session:
        stmt = select(User.datetime).where(User.user_id == message.from_user.id)
        r = await session.execute(statement=stmt)
        date = r.scalar()

    date_format = "%Y-%m-%d"
    d1 = datetime.datetime.strptime(date, date_format)
    d2 = datetime.datetime.strptime(datetime.datetime.now().strftime('%Y-%m-%d'), date_format)
    
    days = abs((d2 - d1).days)

    if days <= 90:
        await message.answer("–¢—ã –ø–æ–∫–∞ —á—Ç–æ –Ω–µ –º–æ–∂–µ—à—å –ø–µ—Ä–µ–ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ —Ç—Ä–∏ –º–µ—Å—è—Ü–∞!!!")
    else:
        await message.answer("""–í–æ—Ç —Ç–µ–±–µ —Å—Å—ã–ª–æ—á–∫–∏ –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
    <a href="https://onlinetestpad.com/s/academic-text-skills">–¢–µ—Å—Ç 1</a>
    <a href="https://onlinetestpad.com/t/borzova-text-test">–¢–µ—Å—Ç 2</a>
    <a href="https://onlinetestpad.com/t/starkey2004-lutsenko2014">–¢–µ—Å—Ç 3</a>
    <a href="https://onlinetestpad.com/t/arpov-reflection-test">–¢–µ—Å—Ç 4</a>
    <a href="https://onlinetestpad.com/t/Metacognition-activity">–¢–µ—Å—Ç 5</a>
    <a href="https://onlinetestpad.com/t/merkulova-ak-test">–¢–µ—Å—Ç 6</a>""", parse_mode="html")


if __name__ == "__main__":
    executor.start_polling(skip_updates=True, dispatcher=dp)